<p-table #dt [columns]="cols" [value]="bugsToView" [paginator]="true" [rows]="5" [customSort]="true"
         (sortFunction)="customSort($event)" (onRowSelect)="onRowSelect($event)"
         selectionMode="single" [(selection)]="selectedBug" [style]="{width: '100%'}">

  <ng-template pTemplate="caption">
    <div style="text-align: right">
      <input type="text" pInputText size="50" placeholder="Global Filter"
             (input)="dt.filterGlobal($event.target.value, 'contains')"
             [ngStyle]="{'width':'800px'}">
    </div>
  </ng-template>

  <ng-template pTemplate="header" let-columns>
    <tr>
      <th *ngFor="let col of cols" [pSortableColumn]="col.field" pResizableColumn pReorderableColumn [ngStyle]="{'width':col.width}">
        {{col.header}}
        <p-sortIcon [field]="col.field"></p-sortIcon>
      </th>
    </tr>

    <tr>
      <th *ngFor="let col of cols" [ngSwitch]="col.field">
        <input *ngSwitchCase="'title'" pInputText type="text"
               (input)="dt.filter($event.target.value, col.field, col.filterMatchMode)" [ngStyle]="{'width':'100px'}">

        <input *ngSwitchCase="'description'" pInputText type="text"
               (input)="dt.filter($event.target.value, col.field, col.filterMatchMode)" [ngStyle]="{'width':'110px'}">

        <input *ngSwitchCase="'version'" pInputText type="text"
               (input)="dt.filter($event.target.value, col.field, col.filterMatchMode)" [ngStyle]="{'width':'50px'}">

        <p-calendar #cal=ngModel ngModel name="calendar" id="calendar" [style]="{'width': '300px'}"
                    *ngSwitchCase="'targetDate'" [defaultDate]="" [readonlyInput]="false" dateFormat="yy-MM-dd"
                    (onSelect)="dt.filter($event, col.field, 'dateFilter')"></p-calendar>

        <p-multiSelect *ngSwitchCase="'status'" [options]="statusTypes" defaultLabel="All Types"
                       (onChange)="dt.filter($event.value, col.field, 'in')"></p-multiSelect>

        <input *ngSwitchCase="'fixedVersion'" pInputText type="text"
               (input)="dt.filter($event.target.value, col.field, col.filterMatchMode)" [ngStyle]="{'width':'50px'}">

        <p-multiSelect *ngSwitchCase="'severity'" [options]="severityTypes" defaultLabel="All Types"
                       (onChange)="dt.filter($event.value, col.field, 'in')"></p-multiSelect>

        <p-dropdown *ngSwitchCase="'createdId'" [options]="usernamesForFilter"
                    (onChange)="dt.filter($event.value, col.field, 'equals')"></p-dropdown>

        <p-dropdown *ngSwitchCase="'assignedId'" [options]="usernamesForFilter"
                    (onChange)="dt.filter($event.value, col.field, 'equals')"></p-dropdown>
      </th>
    </tr>
  </ng-template>


  <ng-template pTemplate="body" let-rowData let-bugsToView>
    <tr [pSelectableRow]="rowData">
      <td>{{bugsToView.title}}</td>
      <td><textarea>{{bugsToView.description}}</textarea></td>
      <td>{{bugsToView.version}}</td>
      <td>{{bugsToView.targetDate | date:'yyyy-MM-dd'}}</td>
      <td>{{bugsToView.status}}</td>
      <td>{{bugsToView.fixedVersion}}</td>
      <td>{{bugsToView.severity}}</td>
      <td>{{bugsToView.createdId}}</td>
      <td>{{bugsToView.assignedId}}</td>
    </tr>
  </ng-template>
</p-table>


<p-dialog header="Bug Details" [(visible)]="displayBugPopUp" [responsive]="true" [modal]="true"
          [style]="{width: '1000px', height: '1100px'}">
  <form #editBugForm="ngForm" (ngSubmit)=editBug(editBugForm)>

    <div class="ui-g ui-fluid" *ngIf="popUpBug">

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="title">Title</label>
        </div>
        <div class="ui-g-8">
          <input pInputText
                 required
                 pattern="^\d*[a-zA-Z][a-zA-Z\d]*$"
                 id="title"
                 name="title"
                 class="form-control"
                 #title="ngModel"
                 [disabled]="!userHasManagementPermission"
                 [(ngModel)]="popUpBug.title"
          />
          <div *ngIf="title.touched && title.invalid">
            <div *ngIf="title.errors.required" style="color:red">
              *Title is required.
            </div>
            <div *ngIf="title.errors.pattern" style="color:red">
              *Invalid title.
            </div>
          </div>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="description">Description</label>
        </div>
        <div class="ui-g-8">
          <textarea required
                    minlength=250
                    id="description"
                    name="description"
                    class="form-control"
                    #description="ngModel"
                    rows="5" cols="50"
                    [disabled]="!userHasManagementPermission"
                    [(ngModel)]="popUpBug.description">
          </textarea>
          <div *ngIf="description.touched && description.invalid">
            <div *ngIf="description.errors.required" style="color:red">
              *Description is required.
            </div>
            <div *ngIf="description.errors.minlength" style="color:red">
              *Invalid description. Description must have a minimum of 250 characters.
            </div>
          </div>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="version">Version</label>
        </div>
        <div class="ui-g-8">
          <input pInputText
                 required
                 pattern="^[0-9.]*$"
                 id="version"
                 name="version"
                 class="form-control"
                 #version="ngModel"
                 [disabled]="!userHasManagementPermission"
                 [(ngModel)]="popUpBug.version"
          />
          <div *ngIf="version.touched && version.invalid">
            <div *ngIf="version.errors.required" style="color:red">
              *Version is required.
            </div>
            <div *ngIf="version.errors.pattern" style="color:red">
              *Invalid version. Versions must be of the form '1.1.1'
            </div>
          </div>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="targetDate">Target Date</label>
        </div>
        <div class="ui-g-8">
          <p-calendar ngModel name="targetDate" id="targetDate" #targetDate="ngModel" [style]="{'width': '300px'}"
                      [disabled]="!userHasManagementPermission"
                      [(ngModel)]="selectedBugDate" dateFormat="yy-MM-dd"></p-calendar>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="status">Status</label>
        </div>
        <div class="ui-g-8">
          <p-dropdown id="status" name="status" [options]="getTransitionOptions(popUpBug.status)"
                      [disabled]="((
                      !((userHasBugClosePermission && !userHasManagementPermission) && (isStatusFixed || isStatusRejected)) &&
                      !((!userHasBugClosePermission && userHasManagementPermission) && !(isStatusFixed || isStatusRejected)) ) &&
                      !(userHasBugClosePermission && userHasManagementPermission)
                      )"
                      [(ngModel)]="popUpBug.status"></p-dropdown>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="fixedVersion">Fixed Version</label>
        </div>
        <div class="ui-g-8">
          <input pInputText
                 required
                 pattern="^[0-9.]*$"
                 id="fixedVersion"
                 name="fixedVersion"
                 class="form-control"
                 #fixedVersion="ngModel"
                 [disabled]="!userHasManagementPermission"
                 [(ngModel)]="popUpBug.fixedVersion"
          />
          <div *ngIf="fixedVersion.touched && fixedVersion.invalid">
            <div *ngIf="fixedVersion.errors.pattern" style="color:red">
              *Invalid version. Versions must be of the form '1.1.1'
            </div>
          </div>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="severity">Severity</label>
        </div>
        <div class="ui-g-8">
          <p-dropdown id="severity" name="severity" [options]="severityTypes" [(ngModel)]="popUpBug.severity"
                      [disabled]="!userHasManagementPermission"></p-dropdown>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="createdId">Created by</label>
        </div>
        <div class="ui-g-8">
          <input pInputText id="createdId" name="createdId" [disabled]="true" [(ngModel)]="popUpBug.createdId"/>
        </div>
      </div>

      <div class="ui-g-12">
        <div class="ui-g-4">
          <label for="assignedId">Assigned to</label>
        </div>
        <div class="ui-g-8">
          <p-dropdown id="assignedId" name="assignedId" [options]="createdByUsernamesForDropDown"
                      [disabled]="!userHasManagementPermission"
                      [(ngModel)]="popUpBug.assignedId"></p-dropdown>
        </div>
      </div>
    </div>

    <button class="btn btn-primary" style="margin-top:3%" [hidden]="!userHasManagementPermission"
            [disabled]="editBugForm.invalid">Edit Bug
    </button>

  </form>
</p-dialog>
